agents:
  queue: kibana-default

steps:
    # It's easier to do this through a required env var, than an input.
    #  Inputs are not accessible in the pipeline code,
    #  so you'd have to get a script to dig up the meta-data, then emit a build step to buildkite
  - label: "Ensure required ENV variable ESS_IMAGE_URL_OR_TAG"
    if: "build.env('ESS_IMAGE_URL_OR_TAG') == null"
    command: |
      echo "Please provide the env variable ESS_IMAGE_URL_OR_TAG for the build."
      buildkite-agent annotate --style error "Missing environment variable ESS_IMAGE_URL_OR_TAG"
      exit 1

  - wait: ~

  - label: ":pipeline: (:kibana: x :elastic:) Trigger Kibana Serverless suite"
    trigger: "kibana-serverless"
    if: "build.env('SKIP_VERIFICATION') != '1' && build.env('SKIP_VERIFICATION') != 'true'"
    build:
      commit: ${BUILDKITE_COMMIT}
      branch: ${BUILDKITE_BRANCH}
      env:
        TEST_ESS_IMAGE: ${ESS_IMAGE_URL_OR_TAG}

  - wait: ~

  - label: ":arrow_up::elastic::arrow_up: Promote docker image"
    command: .buildkite/scripts/steps/es_snapshots/promote_ess_image.sh $ESS_IMAGE_URL_OR_TAG
